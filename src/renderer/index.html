<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://alcdn.msauth.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' http://localhost:* ws://localhost:* https://login.microsoftonline.com https://graph.microsoft.com https://alcdn.msauth.net; form-action 'self';">
    <title>MCP Desktop</title>
    <link rel="stylesheet" href="./modern-ui.css">
</head>
<body>
    <header class="app-header">
        <div class="container header-content">
            <div class="app-logo">MCP Desktop</div>
            <div id="status-indicators"></div>
        </div>
    </header>
    
    <div class="app-container">
        <!-- Sidebar with Microsoft 365 Integration Status -->
        <aside class="sidebar" id="app-sidebar">
            <div class="sidebar-section">
                <h3>Microsoft 365 Authentication</h3>
                <p>Connect to your Microsoft 365 account to access your data.</p>
                <button id="device-auth-button" class="btn btn-primary">
                    Connect to Microsoft 365
                </button>
                <div id="auth-status" class="auth-status mt-2 hidden">
                    <div class="status-indicator"></div>
                    <span class="status-text">Not connected</span>
                </div>
            </div>

            <div id="mcp-token-section" class="sidebar-section hidden">
                <h3>üîë MCP Token Generation</h3>
                <p>Generate a bearer token for Claude Desktop MCP integration.</p>
                <button id="generate-mcp-token-button" class="btn btn-secondary">
                    Generate MCP Token
                </button>
                <div id="mcp-token-result" class="mt-2 hidden">
                    <div class="token-display">
                        <label for="mcp-token-text">Bearer Token (expires in 24h):</label>
                        <textarea id="mcp-token-text" class="form-control" rows="3" readonly></textarea>
                        <button id="copy-token-button" class="btn btn-sm btn-outline-primary mt-1">
                            üìã Copy Token
                        </button>
                    </div>
                    <div class="config-example mt-2">
                        <label>Step 1: Download the MCP Adapter</label>
                        <div class="config-buttons mt-1 mb-2">
                            <button id="download-adapter-button" class="btn btn-sm btn-secondary">
                                ‚¨áÔ∏è Download mcp-adapter.cjs
                            </button>
                        </div>
                        <label>Step 2: Claude Desktop Config:</label>
                        <pre id="config-example" class="config-code"></pre>
                        <div class="config-buttons mt-2">
                            <button id="copy-config-button" class="btn btn-sm btn-primary">
                                üìã Copy Config
                            </button>
                        </div>
                        <p class="config-help mt-2">
                            <strong>Instructions:</strong>
                            <br>
                            1. Download the adapter file above
                            <br>
                            2. Update the path in the config to where you saved it
                            <br>
                            3. Add to <code>claude_desktop_config.json</code>
                            <br>
                            <small>Location: <code>~/Library/Application Support/Claude/claude_desktop_config.json</code> (macOS) or <code>%APPDATA%\Claude\claude_desktop_config.json</code> (Windows)</small>
                        </p>
                    </div>
                </div>
            </div>

            <div id="external-token-section" class="sidebar-section">
                <h3>Login with Enterprise Token</h3>
                <p>Paste a Microsoft Graph token from an enterprise tool to authenticate.</p>
                <textarea id="external-token-input" class="form-control" rows="4"
                          placeholder="Paste your Microsoft Graph access token here..."></textarea>
                <button id="inject-external-token-button" class="btn btn-primary mt-2">
                    Login with Token
                </button>

                <div id="external-token-status" class="mt-2 hidden">
                    <div class="token-info-card">
                        <h4>Token Information</h4>
                        <p><strong>User:</strong> <span id="ext-token-user">-</span></p>
                        <p><strong>Email:</strong> <span id="ext-token-email">-</span></p>
                        <p><strong>Scopes:</strong> <span id="ext-token-scope-count">0</span> permissions</p>
                        <p><strong>Expires:</strong> <span id="ext-token-expires">-</span></p>
                        <p><strong>Time Remaining:</strong> <span id="ext-token-countdown" class="token-countdown">-</span></p>

                        <div id="ext-token-warning" class="alert alert-warning hidden">
                            Token expires soon! Please paste a new token.
                        </div>
                    </div>

                    <div class="token-source-toggle mt-2">
                        <label class="toggle-switch">
                            <input type="checkbox" id="use-external-token-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Use External Token</span>
                    </div>

                    <button id="clear-external-token-button" class="btn btn-danger btn-sm mt-2">
                        Clear External Token
                    </button>
                </div>
            </div>

            <div id="adapter-download-section" class="sidebar-section hidden">
                <!-- Device registration and adapter download will be populated here -->
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Details</h3>
                </div>
                <div class="card-body">
                    <div id="system-info">
                        <p><strong>Version:</strong> 2.5.0</p>
                        <p><strong>Environment:</strong> Production</p>
                        <p><strong>Last Updated:</strong> May 16, 2025</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main content area -->
        <main class="main-content">
            <!-- App container where dynamic content will be rendered -->
            <div id="app"></div>
        </main>
    </div>
    
    <!-- Global services (load first) -->
    <script src="./services/global-services.js"></script>
    
    <!-- MSAL library for Microsoft authentication -->
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    
    <!-- Import DOM security utilities -->
    <script src="./dom-safe.js" type="module"></script>
    
    <!-- Import UI notification system -->
    <script src="./ui-notification.js" type="module"></script>
    
    <!-- Import the new modular application -->
    <script src="./services/IPCService.js" type="module"></script>
    <script src="./modules/APIService.js" type="module"></script>
    <script src="./modules/UIManager.js" type="module"></script>
    <script src="./modules/ConnectionManager.js" type="module"></script>
    <script src="./modules/AppController.js" type="module"></script>
    
    <!-- Initialize the application -->
    <script type="module">
        import { AppController } from './modules/AppController.js';
        
        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const appController = new AppController();
            appController.init();
        });
    </script>
</body>
</html>
